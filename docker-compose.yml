services:
  backend:
    build: ./backend
    ports:
      - "37453:37453"
    volumes:
      # Persist data locally
      - ./backend/backend/data:/app/backend/data
      # Allow access to the host projects directory (using relative path for better WSL2 compatibility)
      - ../:/mnt/d/projects:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # Ensure python works correctly in the container
      - PYTHONPATH=/app
      # Service URLs (Pointing to Host)
      - HOST_AGENT_URL=http://host.docker.internal:9876
      - HOST_STATUS_URL=http://host.docker.internal:9876/status
      - GATEWAY_URL=http://host.docker.internal:7083
    restart: unless-stopped
    # Resource limits to prevent runaway consumption
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.50'
        reservations:
          memory: 128M
    # Health check to detect hung processes
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:37453/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    # Limit open file descriptors
    ulimits:
      nofile:
        soft: 1024
        hard: 2048

  frontend:
    build: ./frontend
    ports:
      - "37452:37452"
    environment:
      # Configure the rewrite destination to point to the backend service
      - API_URL="http://backend:37453/api/:path*"
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 64M
